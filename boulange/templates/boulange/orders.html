{% extends "boulange/base.html" %}

{% block title %}Mes commandes{% endblock %}

{% block content %}
<section class="leftbordered">
  {% if order_id %}
  <h2>Modification de commande</h2>
  {% else %}
  <h2>Ajouter une commande au panier</h2>
  {% endif %}
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="order_id" value="{% if order_id %}{{ order_id }}{% endif %}"></input>
    <div class="flex two">
      <select name="weekly_delivery_id"
	      hx-trigger="change, load"
	      hx-post="/hx/get_dates_for_weekly_delivery/"
	      hx-target="#available-dates"
	      hx-swap="outerHTML"
	      hx-vals="js:{event_type: event.type}">
	{% for wdp in available_weekly_deliveries %}
	<option value="{{ wdp.id }}"
		{% if wdp == weekly_delivery %}selected{% endif %}>{{ wdp }}</option>
	{% endfor %}
      </select>
      <div id="available-dates"></div>
    </div>
    <div id="order-lines">
      {% for line in order.lines.all %}
      {% include 'boulange/hx/order_line.html' with line=line %}
      {% endfor %}
    </div>
    <button hx-trigger="click"
	    hx-post="/hx/order_line/"
	    hx-target="#order-lines"
	    hx-swap="beforeend"
	    class="pseudo small">+ ajouter une ligne de commande</button>
    <p>
      Notes optionnelles de commande :<br/>
      <textarea name="notes">{% if order.notes %}{{ order.notes }}{% endif %}</textarea><br/>
    </p>
    <p>
      <button class="big">Enregistrer la commande dans les commandes en cours</button>
    </p>
  </form>
</section>
{% if to_validate %}
<section class="leftbordered">
  <h2>Commandes à valider</h2>
  <form method="POST" action="{% url 'boulange:validate_orders' %}">
    {% csrf_token %}
    <p>
      <button class="success big" onclick="return confirm('Attention : une commande validée vous engage et ne pourra plus être modifiée !');">Valider les commandes</button>
    </p>
    <div class="flex three">
      {% for order in to_validate %}
      <article class="card">
	<header>
	  <b>
	    {{ order.delivery_date.weekly_delivery.customer }}
	    <br>
	    {{ order.delivery_date.date|date:"l d/m/y" }} : {{ order.total_price|floatformat:2 }}€
	  </b>
	</header>
	{% if order.lines.all %}
	<ul>
	  {% for line in order.lines.all %}
	  <li>{{ line.product }}<br>{{ line.product.price }}€ x {{ line.quantity }}</li>
	  {% endfor %}
	</ul>
	{% endif %}
	<a class="button warning small" href="{% url 'boulange:orders' order_id=order.id edit=True %}">Modifier</a>
	<a class="button small" href="{% url 'boulange:orders' order_id=order.id duplicate=True %}">Dupliquer</a>
	<a class="button error small" href="{% url 'boulange:delete_order' order_id=order.id %}" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette commande ?');">Supprimer</a>
      </article>
      {% endfor %}
    </div>
  </form>
</section>
{% endif %}
{% if cart %}
<section class="leftbordered">
  <h2>Panier de commandes en cours</h2>
  <form method="POST" action="{% url 'boulange:validate_cart' %}">
    {% csrf_token %}
    <p>
      <button class="success big">Valider le panier (paiement)</button>
    </p>
    <div class="flex three">
      {% for order in cart %}
      <article class="card">
	<header>
	  <b>
	    {{ order.delivery_date.weekly_delivery.customer }}
	    <br>
	    {{ order.delivery_date.date|date:"l d/m/y" }} : {{ order.total_price|floatformat:2 }}€
	  </b>
	</header>
	{% if order.lines.all %}
	<ul>
	  {% for line in order.lines.all %}
	  <li>{{ line.product }}<br>{{ line.product.price }}€ x {{ line.quantity }}</li>
	  {% endfor %}
	</ul>
	{% endif %}
	<a class="button warning small" href="{% url 'boulange:orders' order_id=order.id edit=True %}">Modifier</a>
	<a class="button small" href="{% url 'boulange:orders' order_id=order.id duplicate=True %}">Dupliquer</a>
	<a class="button error small" href="{% url 'boulange:delete_order' order_id=order.id %}" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette commande ?');">Supprimer</a>
      </article>
      {% endfor %}
    </div>
  </form>
</section>
{% endif %}
<section class="leftbordered">
  <h2>Commandes validées</h2>
  <div class="flex three">
    {% for order in validated_orders %}
    <article class="card">
      <header>
	<b>
	  {{ order.delivery_date.weekly_delivery.customer }}
	  <br>
	  {{ order.delivery_date.date|date:"l d/m/y" }} : {{ order.total_price|floatformat:2 }}€
	</b>
      </header>
      {% if order.lines.all %}
      <ul>
	{% for line in order.lines.all %}
	<li>{{ line.product }}<br>{{ line.product.price }}€ x {{ line.quantity }}</li>
	{% endfor %}
      </ul>
      {% endif %}
      <a class="button small" href="{% url 'boulange:orders' order_id=order.id duplicate=True %}">Dupliquer</a>
      <a class="button small" href="{% url 'boulange:user_delivery_receipt' delivery_date_id=order.delivery_date.id %}">Bon de commande</a>
    </article>
  {% endfor %}
  </div>
</section>
{% endblock %}
